<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  .prose pre {
    background-color: #f3f4f6; /* bg-gray-100 */
    color: #1f2937;            /* text-gray-800 */
    padding: 1rem;
    border-radius: 0.375rem;
    overflow-x: auto;
  }

  .prose code {
    background-color: #f9fafb; /* —á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ –¥–ª—è inline-–∫–æ–¥–∞ */
    color: #d6336c;            /* –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ü–≤–µ—Ç, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ */
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
  }

  .prose pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }
</style>

</head>
<body class="flex min-h-screen bg-gray-100 text-gray-800">

  <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é -->
  <aside class="w-64 bg-white shadow-md p-4">
    <h2 class="text-xl font-semibold mb-4">–ú–µ–Ω—é</h2>
    <ul>
      <li><button class="menu-item w-full text-left py-2 px-3 hover:bg-gray-200 rounded" data-section="reviews">–û—Ç–∑—ã–≤—ã</button></li>
      <li><button class="menu-item w-full text-left py-2 px-3 hover:bg-gray-200 rounded" data-section="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button></li>
    </ul>
  </aside>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="flex-1 p-6 relative">
    <!-- –û—Ç–∑—ã–≤—ã -->
    <section id="reviews-section" class="hidden">
      <h2 class="text-2xl font-bold mb-4">–û—Ç–∑—ã–≤—ã</h2>
      <p id="generatingIndicator" class="text-blue-600 mb-4 hidden">
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–∞... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.
      </p>
      <div id="reviews-list"></div>

      <button id="openModalBtn" class="fixed bottom-6 right-6 bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg hover:bg-blue-700">
        –°–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
      </button>
    </section>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <section id="settings-section" class="hidden">
      <h2 class="text-2xl font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è.</p>
    </section>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">–°–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>

      <label class="block text-sm font-medium mb-1">–ü—Ä–æ–º—Ç:</label>
      <textarea id="promptInput" class="w-full p-2 border rounded mb-4" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º—Ç..."></textarea>

      <label class="block text-sm font-medium mb-1">–ú–æ–¥–µ–ª—å:</label>
      <select id="modelSelect" class="w-full p-2 border rounded mb-4">
        <option value="magistral-medium-2506">magistral-medium-2506 (–¥—É–º–∞—é—â–∞—è)</option>
        <option value="mistral-medium-2505">mistral-medium-2505</option>
        <option value="ministral-8b-2410">ministral-8b-2410</option>
        <option value="ministral-3b-2410">ministral-3b-2410</option>
      </select>

      <div class="flex justify-end gap-2">
        <button id="closeModalBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">–û—Ç–º–µ–Ω–∞</button>
        <button id="generateReviewBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    const sections = {
      reviews: document.getElementById("reviews-section"),
      settings: document.getElementById("settings-section")
    };

    document.querySelectorAll('.menu-item').forEach(btn => {
      btn.addEventListener('click', () => {
        Object.values(sections).forEach(sec => sec.classList.add("hidden"));
        sections[btn.dataset.section].classList.remove("hidden");

        if (btn.dataset.section === "reviews") {
          loadReviews();
        }
      });
    });

    const modal = document.getElementById("modal");
    const promptInput = document.getElementById("promptInput");

    document.getElementById("openModalBtn").addEventListener("click", () => {
      modal.classList.remove("hidden");
    });

    document.getElementById("closeModalBtn").addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    document.getElementById("generateReviewBtn").addEventListener("click", async () => {
      const prompt = promptInput.value.trim();
      const model = document.getElementById("modelSelect").value;

      if (!prompt) return alert("–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –¥–ª—è –ò–ò");

      const openBtn = document.getElementById("openModalBtn");
      const indicator = document.getElementById("generatingIndicator");

      modal.classList.add("hidden");
      openBtn.disabled = true;
      openBtn.classList.add("opacity-50", "cursor-not-allowed");
      indicator.classList.remove("hidden");

      try {
        const res = await fetch("http://localhost:8080/user/review/add", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ req: prompt, model }),
        });

        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");

        promptInput.value = "";
        await loadReviews();
      } catch (err) {
        alert("–û—à–∏–±–∫–∞: " + err.message);
      } finally {
        openBtn.disabled = false;
        openBtn.classList.remove("opacity-50", "cursor-not-allowed");
        indicator.classList.add("hidden");
      }
    });

    async function loadReviews() {
      const container = document.getElementById("reviews-list");
      container.innerHTML = "<p class='text-gray-500'>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";

      try {
        const res = await fetch("http://localhost:8080/user/review/get");
        const data = await res.json();

        if (!Array.isArray(data)) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");

        data.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (data.length === 0) {
          container.innerHTML = "<p class='text-gray-500'>–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>";
          return;
        }

        container.innerHTML = data.map((item, index) => `
          <div class="bg-white p-4 rounded-lg shadow-md mb-4">
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-semibold text-lg text-gray-800">–û—Ç–∑—ã–≤${item.user}</h3>
              <span class="text-sm text-gray-500">${formatDate(item.date)}</span>
            </div>
            <p class="text-sm text-gray-700 mb-2"><strong>–ó–∞–ø—Ä–æ—Å:</strong> ${item.request}</p>
              <div class="mt-2">
  <p class="font-semibold">–û—Ç–≤–µ—Ç:</p>
  <div class="prose max-w-none mt-1 bg-gray-50 p-3 rounded" id="answer-${index}"></div>
</div>

            <div class="flex gap-3 mt-4">
              <button class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600 text-sm delete-review-btn" data-id="${item.id}">
                üóë –£–¥–∞–ª–∏—Ç—å
              </button>
              <button class="bg-gray-200 text-gray-800 px-4 py-1 rounded hover:bg-gray-300 text-sm info-review-btn" data-index="${index}">
                ‚Ñπ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
              </button>
            </div>

<div class="mt-3 hidden info-block space-y-1 text-sm text-gray-600" id="info-${index}">
  <p><strong>–ú–æ–¥–µ–ª—å:</strong> ${item.model}</p>
  <p><strong>–û—Ç–≤–µ—Ç:</strong> ${getStats(item.answer)}</p>
  ${item.think && item.think.trim()
    ? `<div><strong>–ú—ã—Å–ª—å:</strong> 
         <span class="block mt-1 bg-gray-100 p-2 rounded" id="think-${index}">${item.think}</span>
         <button class="mt-1 text-blue-600 text-xs toggle-think-btn" data-index="${index}">–°–∫—Ä—ã—Ç—å –º—ã—Å–ª—å</button>
       </div>`
    : ''
  }
</div>


          </div>
        `).join("");
        data.forEach((item, index) => {
  const answerEl = document.getElementById(`answer-${index}`);
  if (answerEl) {
    answerEl.innerHTML = marked.parse(item.answer || "");
  }
});

document.querySelectorAll(".toggle-think-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const index = btn.dataset.index;
    const thinkBlock = document.getElementById(`think-${index}`);
    const isHidden = thinkBlock.classList.toggle("hidden");
    btn.textContent = isHidden ? "–ü–æ–∫–∞–∑–∞—Ç—å –º—ã—Å–ª—å" : "–°–∫—Ä—ã—Ç—å –º—ã—Å–ª—å";
  });
});
        // –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
        document.querySelectorAll(".delete-review-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?")) return;

    const reviewCard = btn.closest(".bg-white.rounded-lg.shadow-md");
    if (reviewCard) {
      reviewCard.remove(); // –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –∏–∑ DOM
    }

    // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–∑–∂–µ –≤—ã–∑–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å
     
    fetch("http://localhost:8080/user/review/delete", {
      method: "POST",
      body: new URLSearchParams({ id: btn.dataset.id }),
    }).catch(err => {
      console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
    });
     
  });
});

        // –ü–æ–∫–∞–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        document.querySelectorAll(".info-review-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const block = document.getElementById(`info-${btn.dataset.index}`);
            const isHidden = block.classList.toggle("hidden");
            btn.textContent = isHidden ? "‚Ñπ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" : "‚ùå –°–∫—Ä—ã—Ç—å";
          });
        });

      } catch (err) {
        container.innerHTML = `<p class="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
      }
    }
function getStats(text) {
  const symbols = text.length;
  const words = text.trim().split(/\s+/).filter(Boolean).length;
  const lines = text.split("\n").length;
  return `${symbols} —Å–∏–º–≤–æ–ª–æ–≤, ${words} —Å–ª–æ–≤, ${lines} —Å—Ç—Ä–æ–∫`;
}

    function formatDate(isoDate) {
      const date = new Date(isoDate);
      return date.toLocaleString("ru-RU", {
        day: "2-digit",
        month: "long",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }
  </script>
</body>
</html>
